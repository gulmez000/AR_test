<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Resim Yerleştirici (En Basit İstek)</title>
    <style>
        /* Stiller öncekiyle aynı... */
        body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
        canvas { display: block; }
        #ar-start-button {
            position:fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 999; padding: 12px 20px; background-color: #6a0dad; color: white;
            border: none; border-radius: 5px; font-weight: bold; cursor: pointer;
            font-size: 16px;
        }
        #ui-container { /* Diğer UI elemanları şimdilik tamamen kaldırıldı */
           display: none;
        }
        #instructions {
            position: fixed; top: 70px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.7);
            color: white; padding: 8px 15px; border-radius: 10px; z-index: 10; text-align: center;
            max-width: 90%; font-size: 14px; pointer-events: none;
        }
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8);
            color: white; display: none; justify-content: center; align-items: center; z-index: 100; text-align: center;
        }
    </style>
</head>
<body>
    <!-- Sabit AR Başlatma Butonu -->
    <button id="ar-start-button">AR Başlat (Son Deneme)</button>

    <div id="loading-screen">AR Başlatılıyor...</div>
    <div id="instructions">Başlamak için butona dokunun.</div>

    <!-- Resim seçme vs şimdilik kaldırıldı -->
    <!-- <input type="file" id="image-input" accept="image/*"> -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // --- Değişkenler ---
        let camera, scene, renderer;
        let controller = null; // Başlangıçta null
        let currentSession = null;
        let referenceSpace = null;
        let arButton = null;
        let debugCube = null; // Hata ayıklama için küp

        // --- UI Elementleri ---
        const loadingScreen = document.getElementById('loading-screen');
        const instructionsElement = document.getElementById('instructions');

        // --- Başlatma (Three.js Sahnesi) ---
        function init() {
            console.log("--- init() CALLED ---");
            try {
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 40);
                const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 3); // Biraz daha parlak
                scene.add(light);

                // Debug Küpü
                const geometry = new THREE.BoxGeometry(0.2, 0.2, 0.2);
                const material = new THREE.MeshNormalMaterial();
                debugCube = new THREE.Mesh(geometry, material);
                debugCube.position.z = -1; // Kameranın 1 birim önüne koy
                scene.add(debugCube);
                console.log("Debug cube added.");

                renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.xr.enabled = true;
                document.body.appendChild(renderer.domElement);
                console.log("Renderer created.");

                // Controller (Sadece AR oturumu başladığında ekleyelim)

                window.addEventListener('resize', onWindowResize);
                renderer.setAnimationLoop(render);
                console.log("--- init() COMPLETED ---");
                updateUI();

            } catch (error) {
                console.error("!!! ERROR during init():", error);
                alert("Sahne başlatılırken hata oluştu: " + error.message);
                instructionsElement.textContent = "Hata: Başlatılamadı.";
            }
        }

        // --- AR Oturumu Başlatma ---
        function startARSession() {
            console.log("--- startARSession() CALLED (MOST BASIC Request) ---");
            if (!navigator.xr) { alert("WebXR desteklenmiyor!"); return; }
            if (currentSession) { console.log("Session already active."); return; }

            loadingScreen.innerText = "AR Oturumu İsteniyor (En Basit)...";
            loadingScreen.style.display = 'flex';
            if (arButton) arButton.style.display = 'none';

            // *** EN BASİT İSTEK: Sadece immersive-ar isteyelim ***
            // Özellik istemeyelim, tarayıcı varsayılanı seçsin.
            navigator.xr.requestSession('immersive-ar', {
                 // requiredFeatures: [], // Boş bırakalım veya hiç belirtmeyelim
                 // optionalFeatures: [],
                 domOverlay: { root: document.body } // Bu genellikle gerekli
            }).then(onSessionStarted)
              .catch(err => {
                 console.error("!!! AR Session request FAILED (MOST BASIC):", err);
                 alert("AR oturumu başlatılamadı (En Basit İstek).\nNeden: " + err.message);
                 loadingScreen.style.display = 'none';
                 if (arButton) arButton.style.display = 'block';
            });
        }

        function onSessionStarted(session) {
            console.log('--- onSessionStarted() CALLED ---', session);
            // Desteklenen özellikleri logla
            if (session.supportedFeatures) {
                 console.log("Session supported features:", Array.from(session.supportedFeatures));
            } else {
                 console.warn("session.supportedFeatures not available.");
            }
            // Render state'i logla (desteklenen referans uzaylarını içerebilir)
             if(session.renderState) {
                console.log("Session renderState:", session.renderState);
             }


            currentSession = session;
            session.addEventListener('end', onSessionEnded);

             // Controller'ı şimdi ekle
             if (!controller) {
                 controller = renderer.xr.getController(0);
                 // controller.addEventListener('select', onSelect); // onSelect şimdilik yok
                 scene.add(controller);
                 console.log("Controller added to scene.");
             }


            // *** Referans Uzayı: Hala 'viewer' istemeyi deneyelim ***
            // Eğer bu da başarısız olursa, sorun çok daha temel.
            console.log("Attempting to request reference space 'viewer'...");
            session.requestReferenceSpace('viewer').then((refSpace) => {
                console.log("Reference space 'viewer' obtained.");
                referenceSpace = refSpace;
                // Hit test yok.
                hitTestSourceRequested = false;
                hitTestSource = null;
                return renderer.xr.setSession(session);
            }).then(() => {
                console.log("Renderer XR session set successfully.");
                loadingScreen.style.display = 'none';
                updateUI(); // UI'ı güncelle (sadece talimatlar vs.)
            }).catch(err => {
                // *** BURASI KRİTİK: Hata hala geliyorsa logla ***
                console.error("!!! FAILED to get 'viewer' reference space OR setSession:", err);
                 alert("AR oturumu ayarlanırken HATA ('viewer' isteme aşamasında): " + err.message + "\nCihazınız temel 'viewer' uzayını bile desteklemiyor olabilir.");
                 loadingScreen.style.display = 'none';
                 if (currentSession) { currentSession.end().catch(e => {}); }
                 if (arButton) arButton.style.display = 'block';
            });
        }

        function onSessionEnded() {
             console.log('--- onSessionEnded() CALLED ---');
             currentSession = null; referenceSpace = null;
             // Controller'ı kaldır
             if(controller) {
                 scene.remove(controller);
                 // controller.removeEventListener('select', onSelect); // Gerekirse
                 controller = null;
                 console.log("Controller removed.");
             }
              renderer.xr.setSession(null).catch(err => console.error("Error clearing renderer session:", err));
             updateUI(); // UI'ı sıfırla
             alert("AR Oturumu sonlandı.");
        }

        // --- Diğer Fonksiyonlar (Çoğu kaldırıldı) ---
        function onWindowResize() {
            if (!renderer) return; // Henüz başlatılmamış olabilir
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- UI Güncelleme ---
        function updateUI() {
            const isARActive = !!currentSession; // Oturum varsa AR aktiftir
            console.log(`updateUI: isAR=${isARActive}`);

            // AR Başlat Butonu
            if (arButton) { arButton.style.display = isARActive ? 'none' : 'block'; }

            // Talimatlar
            if (!isARActive) {
                 instructionsElement.textContent = "Başlamak için butona dokunun.";
            } else {
                // Referans uzayı alındı mı?
                if(referenceSpace) {
                    instructionsElement.textContent = "AR Aktif ('viewer' modu). Küp görmelisiniz.";
                } else {
                     instructionsElement.textContent = "AR Oturumu başladı, referans uzayı bekleniyor...";
                }
            }
            // Diğer UI elemanları yok/gizli
        }


        // --- Render Döngüsü ---
        function render(timestamp, frame) {
             if (!renderer) return; // Renderer yoksa çık
             const isARActive = renderer.xr.isPresenting;

             // Küpü her zaman döndür (AR olsun olmasın, init başarılıysa)
             if (debugCube) {
                 debugCube.rotation.x += 0.005;
                 debugCube.rotation.y += 0.01;
             }

             if (!isARActive) {
                 try { renderer.render(scene, camera); } catch(e) {}
                 return;
             }

             // --- AR Aktif ---
             if (!currentSession || !frame ) { // referans uzayı olmasa bile render edelim
                 try { renderer.render(scene, camera); } catch(e) {} // Sadece kamerayı render et
                 return;
             }

             // Başka AR güncellemesi yok (reticle, hit-test, anchor...)

             // --- Final Render ---
             try {
                 renderer.render(scene, camera);
             } catch(e) {
                 console.error("!!! Render loop error:", e);
                 if (currentSession) { currentSession.end().catch(err => {}); }
             }
        }

        // --- Uygulamayı Çalıştır ---
        window.addEventListener('load', () => {
            console.log("--- window loaded ---");
            arButton = document.getElementById('ar-start-button');
            if (arButton) {
                arButton.onclick = startARSession;
                console.log("AR Button event listener attached.");
            } else {
                console.error("AR Start Button (#ar-start-button) not found!");
                instructionsElement.textContent = "Hata: Başlatma butonu bulunamadı.";
                return;
            }
            init(); // Three.js sahnesini hazırla
            console.log("Initial setup complete. Waiting for button click.");
        });

    </script>
</body>
</html>
